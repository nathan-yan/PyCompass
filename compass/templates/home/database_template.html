<!DOCTYPE html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel = 'stylesheet' href = 'https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/css/materialize.min.css'>
<script src = 'https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/js/materialize.min.js'></script>
<link href = 'https://fonts.googleapis.com/icon?family=Material+Icons' rel = 'stylesheet'>

<link rel="stylesheet" href="https://use.typekit.net/rzr6kwp.css">


<script src = "https://www.jsdelivr.com/package/npm/chart.js?path=dist"></script>
<script src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.js"></script>

<script src="https://use.typekit.net/rzr6kwp.js"></script>
<script>try{Typekit.load({ async: true });}catch(e){}</script>

<link rel="stylesheet" href="../static/css/avenir.css">

<style>
    body {
        font-family: AvenirNextLTW01-Medium;
    }

    #collection-card {
        width: 300px;
        position: fixed; 

top: 50px;
left: 0; 

padding: 30px; 
    }

    .width-100 {
        width: 100%;
    }

    .height {
        height: 100%; 
    }

    .page {
        width: 100%; height: 100%;
    }

    .fill-input {
        font-weight: 700 !important;
        color: #20204f !important;
        border-color:rgba(80, 108, 199, 0.686) !important;
        border-style: none !important;
        border-width: 2px !important; 

        background: #ddd !important;
    
        border-radius: 8px !important; 
        padding: 10px 15px 10px 15px !important;

        outline-style: none !important;
        box-shadow: none !important;

        margin-bottom: 0px !important;

        width: 50% !important;

        height: 23px !important;
        
    }

    .fill-input:focus {
        /*box-shadow: 0 16px 24px 2px rgba(0,0,0,0.14), 0 6px 30px 5px rgba(0,0,0,0.12), 0 8px 10px -5px rgba(0,0,0,0.3) !important;*/
    }

    ::placeholder { /* Most modern browsers support this now. */
        color:    #40405f;
    }

    .db-name {
        font-size: 40px;
        font-weight: 700;
    }

    .db {
        display: flex;
        width: 100%;

        min-height: 100px;

        border-radius: 8px; 
        background: #2222b6;

        margin-bottom: 20px;
        padding: 20px;

        color: white;
    }

    .db:hover {
        background: #1212a6;
    }

    .db-name {
        width: 50%;
        height: 100%;
    }

    .db-collections {
        display: flex;
        flex-wrap: wrap;
        width: 50%;

            flex-direction: row-reverse;
    }

    .db-collection {
        height: fit-content; 

        padding: 10px 45px 10px 15px;
        border-radius: 5px;

        background: #219b72;
        color: white; 
        margin-right: 10px;
        margin-bottom: 10px;

        font-size: 17px; 

        cursor: pointer;
        width: fit-content; 
    }

    .db-collection:hover {
        background: #118b62;
    }

    .key {
        font-family: Monospace;
        font-weight: 700;

        font-size: 12px;

        min-width: 20px;
    }

    .data {
        font-family: Monospace;
        font-weight: 300;

        font-size: 12px;

        padding-left: 30px;

        width: 100%; 
        word-wrap: break-word;

        min-width: 20px;

    }

    .data-inline {
        padding-left: 0px;
    }

    .document {
        padding: 20px;
        background: white;

        border-radius: 8px;
    }

    .data-string {
        color: #4a60df;
    }

    .data-bool {
        color: #741d74;
    }

    .data-number {
        color: #f38a28;
    }

    .data-object {
        padding: 3px 5px 3px 5px;

        background: #44cd55;
        color: white;

        border-radius: 3px;

        font-weight: 700;
    }

    .data-array {
        padding: 3px 5px 3px 5px;

        background: #448fcd;
        color: white;

        border-radius: 3px;

        font-weight: 700;
    }
    

    .data-in-object {
        padding: 10px;
        margin-left: 30px;

        border-radius: 8px; 

        background: #3a3ad411;

        width: fit-content;
        max-width: 100%;

        margin-top: 5px;
    } 

    .document {
        margin-bottom: 20px;
    }

    .hidden {
        display: none;
    }

    .selected-collection {
        background: #aaa;
    }

    .button {
        padding: 10px 25px 10px 25px;
        border-radius: 8px;

        width: fit-content; 
        color: white;

        font-weight: 700;
        margin-right: 15px;

        cursor: pointer;
    }

    #actions {
        display: flex;
    }

    .search-bar {
        width: 500px;

        border-radius: 8px;
        background: #ddd; 
    }

    .truncate {
        display: inline-block !important;
        vertical-align: top;
    }

    .document-action-bar {
        background: #f5f5f5;
        padding: 10px 15px 10px 15px;

        border-radius: 8px;
    }

    .action-button {
        cursor: pointer;
    }

    .data-type {
        font-size: 10px;
        padding: 1px 5px 1px 5px;
        background: #8e53ec;

        border-radius: 4px;
        
        color: white;
        font-weight: 700;

        margin-left: 15px;
    
        width: fit-content;
        display: inline-block;
    }

    .data-type-change:hover {
    cursor: pointer;
    text-decoration: underline; 
    }

    [contenteditable][placeholder]:empty:before {
        content: attr(placeholder);
        color: #bababa;
    }

    .quotes::before { 
        content: '"' !important;
        color: #4a60df !important;
    }

    .quotes::after { 
        content: '"';
    }

    .data-types-list {
        text-align: right; position: absolute; top:14px; right: calc(100% + 45px); background: #5655ff; border-radius: 5px 0px 5px 5px; padding: 5px; padding-left: 15px; z-index: 100000; color: white
    }
</style>

<!--
    mongodb://admin:%s@recordbookcluster0-shard-00-00-l24me.mongodb.net:27017,recordbookcluster0-shard-00-01-l24me.mongodb.net:27017,recordbookcluster0-shard-00-02-l24me.mongodb.net:27017/test?ssl=true&replicaSet=RecordBookCluster0-shard-0&authSource=admin
-->

<html class = 'page' style = 'width: 100%; height: 100%; background: #f5f5f5'>
    <body class = 'page'>
        <div style = 'width: 100%; height: 100%; padding: 50px'>
            <div style = 'font-weight: 300; font-size: 70px; margin-left: 20%'>{{name}}.<span style = 'font-size: 50px'>{{collection_name}}</span></div>
            <div style = 'margin-left: 20%;' id = 'actions'>
                <div class = 'button' style = 'background: #22d49f'>Insert Document</div>
                <div id = 'refresh' class = 'button' style = 'background: #22aad4'><i class = 'material-icons' style = 'font-size: 20px; vertical-align: middle'>refresh</i></div>
                <input class = 'fill-input' id = 'search' style = 'font-family: Monospace' placeholder = 'filter by {field : value}'></input>
            </div>

            <br/>

            <div id = '' class = 'page'>
                <div id = 'collection-card' class = ''>
                    <a style = 'color: white'  href = '/connect'>
                        <div class = 'db-collection' style = 'background: #1212a6'>Return to Databases</div>
                    </a>
                    <br/>
                    {% for collection in collections %}    
                        {% if collection == collection_name %}
                            <div class = 'db-collection selected-collection'>{{collection}}</div>
                        {% else %}
                            <div class = 'db-collection'>{{collection}}</div>
                        {% endif %}
                    {% endfor %}

                </div>

                <div class = 'documents' style = 'margin-left: 25px' id = 'documents'>

                </div>
                
            </div>
        </div>

        <form id = 'view-form' action = '/db' method = 'get'>
        </form>

    </body>
</html>

<script>
    function default_string_factory(idx){
       return  `
        <div>
            <div style = 'position: relative; margin-top: 2px; margin-bottom: 2px'>
                <span class = 'key' contentEditable = 'true' placeholder = 'key'></span> 
                : 
                <span contentEditable = 'true' placeholder = 'value' class = 'data data-inline quotes data-string' id = data-${idx}></span>

                <span class = 'add-field' style = 'position: absolute; top: 0; right: calc(100% + 30px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #ccc; font-size: 12px; vertical-align: text-top'>add_circle</i>
        </span>

        <span class = 'delete-field' style = 'position: absolute; top: 0; right: calc(100% + 15px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #fcc; font-size: 12px; vertical-align: text-top'>remove_circle</i>
        </span>


        <div class="data-type" style = 'position: absolute;top:0; right: calc(100% + 45px)' id="data-type-${id + 1}">
            String
        </div>

                <div class="hidden data-types-list" hidden_ = 'true' style = '' id = data-types-${idx}>
                    <div id = 'type-string-${idx}' class = 'data-type-change type-string'>String</div>
                    <div id = 'type-intdoub-${idx}' class = 'data-type-change type-intdoub'>Integer/Double</div>
                    <div id = 'type-boolean-${idx}' class = 'data-type-change type-boolean'>Boolean</div>
                    <div id = 'type-array-${idx}' class = 'data-type-change type-array'>Array</div>
                    <div id = 'type-object-${idx}' class = 'data-type-change type-object'>Object</div>
                    <div id = 'type-timestamp-${idx}' class = 'data-type-change type-timestamp'>Timestamp</div>
                    <div id = 'type-date-${idx}' class = 'data-type-change type-date'>Date</div>
                    <div id = 'type-objectid-${idx}' class = 'data-type-change type-objectid'>Object ID</div>
                </div>
            </div>
        </div>`;
    }
    
    $('#refresh').click(function(){
        window.location.reload();
    });

    var collections = $('.db-collection');

    for (var i = 0; i < collections.length; i++){
        $(collections[i]).click(function(){
            window.location.href = location.protocol + '//' + location.host + location.pathname + "?collection=" + $(this).html();
                
        })
    }

    var id = 0;


    function parseObject(parent, data){
        for (var key in data) {
            if (typeof data[key] == "object" && !Array.isArray(data[key])){
                var recursive_element = $(`<div>
                                                <div style = 'position: relative; margin-top: 2px; margin-bottom: 5px;'><span class = 'key'>${key}</span> : <span class = 'activates data-object' id = 'activates-${id + 1}'>Object</span>
                                                <div class = 'data data-in-object hidden' style = 'margin-bottom: 5px' id = data-${id + 1}></div>

                                                 <span class = 'add-field' style = 'position: absolute; top: 0; right: calc(100% + 30px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #ccc; font-size: 12px; vertical-align: text-top'>add_circle</i>
        </span>

        <span class = 'delete-field' style = 'position: absolute; top: 0; right: calc(100% + 15px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #fcc; font-size: 12px; vertical-align: text-top'>remove_circle</i>
        </span>


        <div class="data-type" style = 'position: absolute;top:0; right: calc(100% + 45px)' id="data-type-${id + 1}">
            Object
        </div>

                        <div class="hidden data-types-list" hidden_ = 'true' style = '' id = data-types-${id + 1}>
                                <div id = 'type-string-${id + 1}' class = 'data-type-change type-string'>String</div>
                                <div id = 'type-intdoub-${id + 1}' class = 'data-type-change type-intdoub'>Integer/Double</div>
                                <div id = 'type-boolean-${id + 1}' class = 'data-type-change type-boolean'>Boolean</div>
                                <div id = 'type-array-${id + 1}' class = 'data-type-change type-array'>Array</div>
                                <div id = 'type-object-${id + 1}' class = 'data-type-change type-object'>Object</div>
                                <div id = 'type-timestamp-${id + 1}' class = 'data-type-change type-timestamp'>Timestamp</div>
                                <div id = 'type-date-${id + 1}' class = 'data-type-change type-date'>Date</div>
                                <div id = 'type-objectid-${id + 1}' class = 'data-type-change type-objectid'>Object ID</div>
                        </div>
                                         </div></div>`);
                
                $(parent.find(".data")[0]).append(
                    recursive_element
                );

               
                id += 1;
                parseObject(recursive_element, data[key], id);
            }else if (Array.isArray(data[key])){
                var array_element = $(`<div>
                                                <div style = 'position: relative; margin-top: 2px; margin-bottom: 5px;'><span class = 'key'>${key}</span> : <span class = 'activates data-array' id = 'activates-${id + 1}'>Array (${data[key].length})</span>
                                                
                                                    <span class = 'add-field' style = 'position: absolute; top: 0; right: calc(100% + 30px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #ccc; font-size: 12px; vertical-align: text-top'>add_circle</i>
        </span>

        <span class = 'delete-field' style = 'position: absolute; top: 0; right: calc(100% + 15px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #fcc; font-size: 12px; vertical-align: text-top'>remove_circle</i>
        </span>


        <div class="data-type" style = 'position: absolute;top:0; right: calc(100% + 45px)' id="data-type-${id + 1}">
            Array
        </div>

        <div class="hidden data-types-list" hidden_ = 'true' style = '' id = data-types-${id + 1}>
                <div id = 'type-string-${id + 1}' class = 'data-type-change type-string'>String</div>
                                <div id = 'type-intdoub-${id + 1}' class = 'data-type-change type-intdoub'>Integer/Double</div>
                                <div id = 'type-boolean-${id + 1}' class = 'data-type-change type-boolean'>Boolean</div>
                                <div id = 'type-array-${id + 1}' class = 'data-type-change type-array'>Array</div>
                                <div id = 'type-object-${id + 1}' class = 'data-type-change type-object'>Object</div>
                                <div id = 'type-timestamp-${id + 1}' class = 'data-type-change type-timestamp'>Timestamp</div>
                                <div id = 'type-date-${id + 1}' class = 'data-type-change type-date'>Date</div>
                                <div id = 'type-objectid-${id + 1}' class = 'data-type-change type-objectid'>Object ID</div>
        </div>
                                                </div>
                                                <div class = 'data data-in-object hidden' style = 'margin-bottom: 5px' id = data-${id + 1}>
                                                
                                                </div>
                                           </div>`);
                
                $(parent.find(".data")[0]).append(
                    array_element
                );

               

                id += 1

                parseObject(array_element, data[key], id);

            }else {
                var class_type;
                var quotes = '';
                if (typeof data[key] == 'string'){
                    class_type = 'data-string';
                    quotes = 'quotes';
                }else if (typeof data[key] == 'boolean'){
                    class_type = 'data-bool';
                }else if (typeof data[key] == 'number'){
                    class_type = 'data-number';
                }

                
                    var data_element = $(`
<div>
    <div style = 'position: relative; margin-top: 2px; margin-bottom: 2px'>
        <span class = 'key'>${key}</span> 
        : 
        <span class = 'data ${quotes} data-inline ${class_type}' id = data-${id + 1}>${data[key]}</span>

        <span class = 'add-field' style = 'position: absolute; top: 0; right: calc(100% + 30px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #ccc; font-size: 12px; vertical-align: text-top'>add_circle</i>
        </span>

        <span class = 'delete-field' style = 'position: absolute; top: 0; right: calc(100% + 15px);' id = 'add-field-${id + 1}'>
            <i class = 'material-icons' style = 'color: #fcc; font-size: 12px; vertical-align: text-top'>remove_circle</i>
        </span>


        <div class="data-type" style = 'position: absolute;top:0; right: calc(100% + 45px)' id="data-type-${id + 1}">
            String
        </div>

        <div class="hidden data-types-list" hidden_ = 'true' style = '' id = data-types-${id + 1}>
                <div id = 'type-string-${id + 1}' class = 'data-type-change type-string'>String</div>
                                <div id = 'type-intdoub-${id + 1}' class = 'data-type-change type-intdoub'>Integer/Double</div>
                                <div id = 'type-boolean-${id + 1}' class = 'data-type-change type-boolean'>Boolean</div>
                                <div id = 'type-array-${id + 1}' class = 'data-type-change type-array'>Array</div>
                                <div id = 'type-object-${id + 1}' class = 'data-type-change type-object'>Object</div>
                                <div id = 'type-timestamp-${id + 1}' class = 'data-type-change type-timestamp'>Timestamp</div>
                                <div id = 'type-date-${id + 1}' class = 'data-type-change type-date'>Date</div>
                                <div id = 'type-objectid-${id + 1}' class = 'data-type-change type-objectid'>Object ID</div>
        </div>
    </div>
</div>`);
               
                id += 1;

                $(parent.find(".data")[0]).append(
                    data_element
                );

               
            }
        } 
    }

    var document_ = {{documents|safe}};

    $(document).ready(function(){
        if (!document_) {
            console.log('set');
            $('#documents').css('height', '100%');
            $('#documents').html(`<div style = 'width: calc(100% - 320px); height: 50%; background: white; margin-left: 280px; border-radius: 10px; font-size: 30px' class = 'valign-wrapper'><div style = 'width: 100%; text-align: center; color: #ddd'>nothing to show</div></div>`);
        }
    })

    function display_collection(document_){
        $('#documents').html("");
       // document_ = [{"nest1" : {"nest21" : "test", "nest22" : "test!", 'nest' : {'nest' : {'hest' : {'tets' : {'thing' : 35273529573583753}}}}}, "hello" : "world"}]
        var doc = 0;
        id = 0;
        for (var i = 0; i < document_.length; i++){
            var document_element = $(`<div style = 'width: calc(100% - 320px); margin-left: 250px; height: 100%; position: relative' class = 'document' id = 'parent-${i}'>
                <div id = 'actions-${i}' class = 'document-action-bar' style = 'display: flex; position: absolute; right: 20px; top: 20px;'>
                    <i class = 'material-icons edit-action action-button' editing = false style = 'font-size: 15px; margin-right: 20px'>edit</i>
                    <i class = 'material-icons copy-action action-button' style = 'font-size: 15px; margin-right: 20px'>content_copy</i>
                    <i class = 'material-icons duplicate-action action-button' style = 'font-size: 15px; margin-right: 20px'>control_point_duplicate</i>
                    <i class = 'material-icons delete-action action-button' style = 'color: rgb(255, 50, 50); font-size: 15px'>delete</i>
               </div>

                
                <div class = 'data' id = 'data-${id}' style = ''></div>
            </div>`);

            $('#documents').append(document_element);

            parseObject($('#parent-' + i), document_[i]);

        }
    }

    function getElementIndex(element) {
        return element.attr('id').split('-').slice(-1)[0];
    }

    function isLastChild(element, layers){
        layers = layers | 1;

        var parent = element;
        for (var l = 0; l < layers; l++){
            parent = parent.parent();
        }

        return parent.children().last().is(element);

    }

    $('body').on('click', '.activates', function(){
        var idx = getElementIndex($(this));
        var object = $('#data-' + idx);

        if (object.hasClass('hidden')){
            object.removeClass('hidden');
        }else{
            object.addClass('hidden');
        }
    })
        

    $('body').on('click', '.add-field', function(){
        var data_element_this_belongs_to = $(this).parent().parent();

        var idx = getElementIndex($(this));
        var data_element = $(default_string_factory(id + 1));

        id ++;

    data_element.insertAfter(data_element_this_belongs_to);
    });

    $('body').on('click', '.data-type-change', function(){
        var idx = getElementIndex($(this))
        var data = $("#data-" + idx);

        // Just always remove quotes, if it is a string then we'll add it back anyway
        if (data.hasClass("data-string")){
            // Remove the quotes
            data.removeClass('quotes');
        }

        // Get rid of the array element
        if (data.hasClass("data-in-object")){
            // Basically what we're doing is getting what was the data element before, transforming it to a real data element, then deleting the original in-object data element
            var should_be_data = $("#activates-" + idx); 
            should_be_data.attr('class', 'data data-inline');
            should_be_data.attr('contentEditable', 'true');    
            should_be_data.html('');

            $(`#data-${idx}`).remove();
            should_be_data.attr('id', `data-${idx}`);
        }

        if ($(this).hasClass("type-intdoub")){
            data.attr('class', 'data data-inline');
            data.addClass('data-number'); 
        }else if ($(this).hasClass('type-string')){
            data.attr('class', 'data data-inline quotes');
            data.addClass('data-string'); 
        }else if ($(this).hasClass('type-boolean')){
            data.attr('class', 'data data-inline');
            data.addClass('data-boolean'); 
        }else if ($(this).hasClass('type-array')){
            data.attr('class', 'data-array activates');
            data.attr('id', 'activates-' + idx);

            data.html("Array (0)");

            data.parent().parent().append($(`<div class = 'data data-in-object hidden' style = 'margin-bottom: 5px' id = 'data-${idx}'>
                ${default_string_factory(id + 1)}
            </div>`))       // We use id + 1 because we're adding a default field and as a result it's a completely new element

            id ++;
        }
    });

   

    $('body').on('click', '.data-type', function(){
        var idx = getElementIndex($(this));
        $(this).toggleClass('z-depth-3');
        
        var hidden = $('#data-types-' + idx).attr('hidden_');
        $('#data-types-' + idx).toggleClass('z-depth-3');
        console.log(hidden);
        if (hidden == 'true'){
            $('#data-types-' + idx).removeClass("hidden");
            $('#data-types-' + idx).attr('hidden_', "false");
            $(this).css('background', '#5655ff');
        }else{
            $('#data-types-' + idx).addClass("hidden");
            $('#data-types-' + idx).attr('hidden_', "true");
            $(this).css('background', '#8e53ec');
        }
    })

   

            
                // <span class = 'data-array' id = 'activates-${id + 1}'>Array (${data[key].length})</span>
                // <div class = 'data data-in-object hidden' style = 'margin-bottom: 5px' id = data-${id + 1}>
                                                
                //</div>


    $('body').on('click', '.edit-action', function() {
        var editing = $(this).attr("editing");
        console.log(editing);
        var parent = $(this).parent();

        var document = getElementIndex(parent);

        var keys = $('#parent-' + document).find('.key');
        var data = $('#parent-' + document).find('.data-inline');   // .data-inline because these are leaf data nodes, which should be the only editable type

        if (editing == 'false'){
            parent.parent().addClass("z-depth-3");

            for (var k = 0; k < keys.length; k++){
               // console.log(keys[k]);
                $(keys[k]).attr('contentEditable', 'true');
                $(keys[k]).attr('placeholder', 'key');
            }

            for (var d = 0; d < data.length; d++){
               // console.log(keys[k]);
                $(data[d]).attr('contentEditable', 'true');
                $(data[d]).attr('placeholder', 'value');
            }

            $(this).attr('editing', 'true');
        }else {
            parent.parent().removeClass("z-depth-3");

            for (var k = 0; k < keys.length; k++){
                
                //console.log(keys[k]);
                $(keys[k]).attr('contentEditable', 'false');
            }

            for (var d = 0; d < data.length; d++){
               // console.log(keys[k]);
                $(data[d]).attr('contentEditable', 'false');
            }

            $(this).attr('editing', 'false');
        }
    });

    $('body').on('keydown', '.data-inline', function(e){
        // TODO: Check for tab, if is last child then append a new data element
        
        console.log(e);
        if (e.keyCode == 9){
            var isLast = isLastChild($(this).parent().parent());

            if (isLast){
                var key_element = $(default_string_factory(id + 1));
                
                id++;

                $(this).parent().parent().parent().append(key_element);
            }
        }
   })

    display_collection(document_);
</script>